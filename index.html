<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToyTopia - Your World of Fun!</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Nunito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for modern icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* Custom font for the website */
        body {
            font-family: 'Nunito', sans-serif;
            scroll-behavior: smooth;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .fade-in-delay-1 { animation-delay: 0.2s; }
        .fade-in-delay-2 { animation-delay: 0.4s; }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .toast-animation { animation: fadeInOut 3s ease-in-out forwards; }

        /* Hero pattern background */
        .hero-pattern {
            background-color: #7dd3fc;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v9h5v1h-5v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0v-1h5v-9H0V5h6zm10 0h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H6v-1h9v-9H6v-1h9v-9H6v-1h9v-9H6v-1h9v-9H6v-1h9v-9H6v-1h9v-9H6v-1h9v-9H6v-1h9v-9H6V5zm10 0h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9V5zm10 0h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9V5zm10 0h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9V5zm10 0h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9v-9h-9v-1h9V5z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Button click animation */
        .btn-click-effect:active {
            transform: scale(0.95);
            transition: transform 0.1s ease-in-out;
        }
        
        /* Modal transition */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.3s ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.9); transition: all 0.2s ease-in; }

        .search-bar-enter { transform: translateY(-100%); }
        .search-bar-enter-active { transform: translateY(0); transition: transform 0.3s ease-out; }
        .search-bar-leave-active { transform: translateY(-100%); transition: transform 0.3s ease-in; }
        
        /* Prevent button from changing size during content swap */
        .add-to-cart-btn {
            min-width: 105px;
            text-align: center;
        }
        
        /* Product Modal Styles */
        .modal-tab.active {
            border-color: #f97316; /* orange-500 */
            color: #f97316;
            font-weight: 700;
        }
        .thumbnail.active {
            border-color: #f97316;
            box-shadow: 0 0 0 2px #f97316;
        }
        .star-rating svg, .review-form-stars .star-wrapper svg {
            color: #d1d5db; /* gray-300 */
        }
        .star-rating svg.filled, .review-form-stars .star-wrapper.filled svg {
            color: #f59e0b; /* amber-500 */
            fill: #f59e0b;
        }
        #related-products-grid {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #related-products-grid::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .form-input.invalid {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 2px #fecaca; /* red-200 */
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header Section -->
    <header class="bg-white/90 backdrop-blur-lg shadow-sm sticky top-0 z-40 border-b border-gray-200">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <a href="#" class="text-3xl font-black text-sky-500 flex items-center tracking-tighter">
                    <i data-feather="box" class="text-amber-400"></i>
                    <span class="ml-2">ToyTopia</span>
                </a>
                <div class="hidden md:flex items-center space-x-8 font-bold text-gray-600">
                    <a href="#" class="nav-link hover:text-pink-500 transition-colors duration-300">Home</a>
                    <a href="#shop" class="nav-link hover:text-pink-500 transition-colors duration-300">Shop</a>
                    <a href="#new-arrivals" class="nav-link hover:text-pink-500 transition-colors duration-300">New Arrivals</a>
                    <a href="#contact" class="nav-link hover:text-pink-500 transition-colors duration-300">Contact</a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="search-btn" class="text-gray-500 hover:text-sky-500"><i data-feather="search"></i></button>
                    <button id="cart-button" class="text-gray-500 hover:text-sky-500 relative">
                        <i data-feather="shopping-cart"></i>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-pink-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
                    </button>
                    <button id="mobile-menu-button" class="md:hidden text-gray-500 hover:text-sky-500"><i data-feather="menu"></i></button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                <a href="#" class="nav-link block py-2 px-4 text-sm font-semibold text-gray-700 hover:bg-sky-100 rounded-lg">Home</a>
                <a href="#shop" class="nav-link block py-2 px-4 text-sm font-semibold text-gray-700 hover:bg-sky-100 rounded-lg">Shop</a>
                <a href="#new-arrivals" class="nav-link block py-2 px-4 text-sm font-semibold text-gray-700 hover:bg-sky-100 rounded-lg">New Arrivals</a>
                <a href="#contact" class="nav-link block py-2 px-4 text-sm font-semibold text-gray-700 hover:bg-sky-100 rounded-lg">Contact</a>
            </div>
        </nav>
        <!-- Search Bar -->
        <div id="search-bar" class="hidden bg-white border-b p-4 absolute w-full search-bar-enter">
            <div class="container mx-auto flex">
                <input type="text" placeholder="Search for toys..." class="w-full px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                <button class="bg-sky-500 text-white px-6 rounded-r-lg hover:bg-sky-600"><i data-feather="search"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Hero Section -->
        <section class="hero-pattern text-white overflow-hidden">
            <div class="container mx-auto px-6 py-24 lg:py-40 text-center flex flex-col items-center">
                <h1 id="hero-title" class="text-5xl md:text-7xl font-black leading-tight mb-4 drop-shadow-lg fade-in tracking-tighter">Unleash Imagination</h1>
                <p id="hero-subtitle" class="text-lg md:text-xl mb-8 max-w-2xl mx-auto drop-shadow fade-in fade-in-delay-1">Discover a world of wonder with our curated collection of toys for every age and adventure.</p>
                <a href="#shop" class="bg-pink-500 text-white font-bold py-4 px-10 rounded-full hover:bg-pink-600 transition duration-300 transform hover:scale-105 shadow-xl fade-in fade-in-delay-2 btn-click-effect">Shop Bestsellers</a>
            </div>
        </section>

        <!-- Shop by Category Section -->
        <section id="category-section" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-12">Shop by Category</h2>
                <div id="category-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                    <!-- Categories will be injected here by JS -->
                </div>
            </div>
        </section>

        <!-- Featured Products Section -->
        <section id="shop" class="py-20 bg-sky-50">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-12">Our Featured Toys</h2>
                <div id="product-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Product Cards will be injected here by JS -->
                </div>
            </div>
        </section>
        
        <!-- Testimonials Section -->
        <section class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-12">What Our Customers Say</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-gray-50 p-8 rounded-xl">
                        <p class="text-gray-600 mb-4">"An amazing collection of toys! My kids absolutely love the dragon plushie. The quality is fantastic and delivery was super fast."</p>
                        <p class="font-bold text-gray-800">- Priya S.</p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-xl">
                        <p class="text-gray-600 mb-4">"The RoboBuilder kit is a huge hit! It's educational and so much fun. A great way to introduce kids to STEM concepts."</p>
                        <p class="font-bold text-gray-800">- Amit K.</p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-xl">
                        <p class="text-gray-600 mb-4">"I'm so impressed with the quality of the wooden blocks. They are safe, durable, and beautifully made. Highly recommend this store!"</p>
                        <p class="font-bold text-gray-800">- Sunita P.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="contact" class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-black mb-4 text-sky-400 tracking-tighter">ToyTopia</h3>
                    <p class="text-gray-400">Bringing joy and creativity to children everywhere.</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="hover:text-white transition">Home</a></li>
                        <li><a href="#shop" class="hover:text-white transition">Shop</a></li>
                        <li><a href="#contact" class="hover:text-white transition">Contact Us</a></li>
                        <li><a href="#" id="admin-link" class="hover:text-white transition">Admin Panel</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Contact Us</h3>
                    <p id="footer-email" class="text-gray-400">Email: support@toytopia.com</p>
                    <p id="footer-phone" class="text-gray-400">Phone: +91 12345 67890</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Follow Us</h3>
                    <div class="flex space-x-4">
                        <a href="#" id="facebook-link" class="text-gray-400 hover:text-white transition"><i data-feather="facebook"></i></a>
                        <a href="#" id="instagram-link" class="text-gray-400 hover:text-white transition"><i data-feather="instagram"></i></a>
                        <a href="#" id="twitter-link" class="text-gray-400 hover:text-white transition"><i data-feather="twitter"></i></a>
                    </div>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-500 text-sm">
                &copy; 2025 ToyTopia. All Rights Reserved.
            </div>
        </div>
    </footer>

    <!-- Add to Cart Notification -->
    <div id="cart-toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 font-semibold flex items-center space-x-2 z-50">
        <i data-feather="check-circle" class="w-5 h-5"></i>
        <span>Item added to cart!</span>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-start hidden p-4 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl mx-auto my-8 modal-enter">
            <div class="p-6 relative">
                <button id="close-product-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 z-10"><i data-feather="x" class="w-8 h-8"></i></button>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Image Gallery -->
                    <div>
                        <img id="modal-main-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-lg mb-4 aspect-square">
                        <div id="modal-thumbnails" class="grid grid-cols-5 gap-2">
                            <!-- Thumbnails injected here -->
                        </div>
                    </div>
                    <!-- Product Details -->
                    <div class="flex flex-col">
                        <h2 id="modal-product-name" class="text-3xl lg:text-4xl font-black text-gray-800 mb-2"></h2>
                        <p id="modal-product-category" class="text-gray-500 mb-4"></p>
                        <div class="flex items-center space-x-2 mb-4">
                            <div id="modal-avg-rating" class="star-rating flex"></div>
                            <span id="modal-review-count" class="text-sm text-gray-500"></span>
                        </div>
                        <span id="modal-product-price" class="text-3xl lg:text-4xl font-extrabold text-sky-600 mb-6"></span>
                        
                        <!-- Offer Banner -->
                        <div id="modal-offer-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg mb-6">
                            <p class="font-bold" id="modal-offer-title"></p>
                            <p id="modal-offer-description"></p>
                        </div>
                        
                        <button data-product-id="" class="add-to-cart-btn w-full bg-teal-500 text-white px-6 py-4 rounded-full hover:bg-teal-600 transition-all duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg font-bold btn-click-effect text-lg">
                            <span class="btn-add-state flex items-center space-x-2">
                                <i data-feather="shopping-bag" class="w-6 h-6"></i>
                                <span class="btn-text">Add to Cart</span>
                            </span>
                            <span class="btn-added-state hidden items-center space-x-2">
                                <i data-feather="check" class="w-6 h-6"></i>
                                <span class="btn-text">Added!</span>
                            </span>
                        </button>
                        
                        <!-- Tabs -->
                        <div class="mt-8 border-t pt-6">
                            <div class="flex border-b mb-4">
                                <button data-tab="description" class="modal-tab py-2 px-4 border-b-2 border-transparent transition-colors duration-300">Description</button>
                                <button data-tab="specs" class="modal-tab py-2 px-4 border-b-2 border-transparent transition-colors duration-300">Specifications</button>
                                <button data-tab="reviews" class="modal-tab py-2 px-4 border-b-2 border-transparent transition-colors duration-300">Reviews</button>
                            </div>
                            <div id="tab-content-description" class="tab-content text-gray-700"></div>
                            <div id="tab-content-specs" class="tab-content hidden text-gray-700"></div>
                            <div id="tab-content-reviews" class="tab-content hidden text-gray-700">
                                <div id="reviews-list"></div>
                                <div class="mt-6">
                                    <button id="write-review-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 transition">Write a Review</button>
                                    <form id="review-form" class="hidden mt-4 p-4 border rounded-lg bg-gray-50 space-y-4">
                                        <h4 class="font-bold text-lg">Submit Your Review</h4>
                                        <div>
                                            <label for="reviewName" class="block text-sm font-medium text-gray-700">Your Name</label>
                                            <input type="text" id="reviewName" required class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Rating</label>
                                            <div class="review-form-stars flex space-x-1 mt-1" data-rating="0">
                                                <span class="star-wrapper cursor-pointer" data-value="1"><i data-feather="star" class="w-6 h-6"></i></span>
                                                <span class="star-wrapper cursor-pointer" data-value="2"><i data-feather="star" class="w-6 h-6"></i></span>
                                                <span class="star-wrapper cursor-pointer" data-value="3"><i data-feather="star" class="w-6 h-6"></i></span>
                                                <span class="star-wrapper cursor-pointer" data-value="4"><i data-feather="star" class="w-6 h-6"></i></span>
                                                <span class="star-wrapper cursor-pointer" data-value="5"><i data-feather="star" class="w-6 h-6"></i></span>
                                            </div>
                                            <p id="rating-error" class="text-red-500 text-sm mt-1 hidden">Please select a rating.</p>
                                        </div>
                                        <div>
                                            <label for="reviewComment" class="block text-sm font-medium text-gray-700">Comment</label>
                                            <textarea id="reviewComment" rows="3" required class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500"></textarea>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Submit Review</button>
                                            <button type="button" id="cancel-review-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- You may also like -->
                <div class="mt-12 border-t pt-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">You May Also Like</h3>
                    <div id="related-products-grid" class="grid grid-flow-col auto-cols-max gap-6 overflow-x-auto pb-4">
                        <!-- Related products injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shopping Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-end hidden">
        <div id="cart-modal-content" class="bg-white w-full max-w-md h-full shadow-2xl flex flex-col modal-enter">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold">Your Cart</h2>
                <button id="close-cart-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-feather="x" class="w-8 h-8"></i></button>
            </div>
            <div id="cart-items" class="flex-grow p-6 overflow-y-auto">
                <!-- Cart items will be injected here -->
            </div>
            <div class="p-6 border-t bg-gray-50">
                <!-- Discount Section -->
                <div class="mb-4">
                    <label for="discountCodeInput" class="block text-sm font-medium text-gray-700 mb-2">Have a discount code?</label>
                    <div class="flex">
                        <input type="text" id="discountCodeInput" placeholder="Enter code" class="flex-grow px-3 py-2 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button id="apply-discount-btn" class="bg-sky-500 text-white px-4 py-2 rounded-r-md hover:bg-sky-600 transition btn-click-effect">Apply</button>
                    </div>
                    <p id="discount-message" class="text-sm mt-2"></p>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold">Subtotal</span>
                    <span id="cart-subtotal" class="text-lg font-bold">₹0.00</span>
                </div>
                <div id="discount-display" class="flex justify-between items-center mb-2 hidden">
                    <span class="text-md font-semibold text-green-700">Discount Applied</span>
                    <span id="discount-amount" class="text-md font-bold text-green-700">- ₹0.00</span>
                </div>
                <div id="gst-display" class="flex justify-between items-center mb-2 hidden">
                    <span class="text-md font-semibold text-gray-700">GST (<span id="cart-gst-percentage">0</span>%)</span>
                    <span id="cart-gst-amount" class="text-md font-bold text-gray-700">₹0.00</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold">Total</span>
                    <span id="cart-total" class="text-xl font-bold text-sky-700">₹0.00</span>
                </div>
                <button id="checkout-btn" class="w-full bg-pink-500 text-white font-bold py-3 rounded-lg hover:bg-pink-600 transition btn-click-effect">Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <!-- Delivery Details Modal -->
    <div id="delivery-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto modal-enter">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold">Delivery & Payment</h2>
                <button id="close-delivery-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-feather="x" class="w-8 h-8"></i></button>
            </div>
            <form id="delivery-form" class="p-6 space-y-4">
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <textarea id="address" name="address" rows="3" required class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500"></textarea>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="city" name="city" required class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="pincode" class="block text-sm font-medium text-gray-700">Pincode</label>
                        <input type="text" id="pincode" name="pincode" required pattern="[0-9]{6}" title="Enter a 6-digit pincode" class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                    </div>
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required pattern="[0-9]{10}" title="Enter a 10-digit phone number" class="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                </div>
                
                <!-- Payment Method Selection -->
                <div class="pt-4 border-t">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Payment Method</h3>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-500">
                            <input type="radio" name="paymentMethod" value="razorpay" class="h-4 w-4 text-sky-600 focus:ring-sky-500" checked>
                            <span class="ml-3 text-sm font-medium text-gray-700">Pay Online (Card, UPI, Netbanking)</span>
                        </label>
                        <label id="cod-option-label" class="flex items-center p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-500 hidden">
                            <input type="radio" name="paymentMethod" value="cod" class="h-4 w-4 text-sky-600 focus:ring-sky-500">
                            <span class="ml-3 text-sm font-medium text-gray-700">Cash on Delivery</span>
                        </label>
                        <p id="cod-advance-message" class="text-xs text-slate-500 pl-3 hidden"></p>
                    </div>
                </div>
                
                <button type="submit" id="confirm-order-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition btn-click-effect flex items-center justify-center space-x-2">
                    <span id="confirm-order-text">Confirm Order & Pay</span>
                    <div id="confirm-order-spinner" class="spinner hidden"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Checkout Success Modal -->
    <div id="checkout-success-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl text-center p-8 max-w-sm mx-auto modal-enter">
            <i data-feather="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Thank You!</h3>
            <p class="text-gray-600 mb-6">Your order has been placed successfully.</p>
            <button id="close-checkout-modal-btn" class="bg-sky-500 text-white font-bold py-2 px-6 rounded-full hover:bg-sky-600 transition btn-click-effect">Continue Shopping</button>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC6d4IFA1q5JLQjWiCI46CYr_zWdklvoNs",
            authDomain: "tddd-ff95c.firebaseapp.com",
            projectId: "tddd-ff95c",
            storageBucket: "tddd-ff95c.appspot.com",
            messagingSenderId: "739673617101",
            appId: "1:739673617101:web:2840eb62258a6ca4feef84"
        };
        
        let products = [];
        let cart = [];
        let currentProductId = null;
        let appliedDiscount = null; 
        let siteSettings = {}; // Store all site settings globally

        // --- Main App Initialization ---
        async function main() {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                return;
            }

            const productsCollection = collection(db, 'products');
            const categoriesCollection = collection(db, 'categories');
            const customersCollection = collection(db, 'customers');
            const discountsCollection = collection(db, 'discounts');
            const ordersCollection = collection(db, 'orders');
            const siteContentRef = doc(db, 'site_content', 'main');

            // --- UI Elements ---
            const mainContent = document.getElementById('main-content');
            const productGrid = document.getElementById('product-grid');
            const categoryGrid = document.getElementById('category-grid');
            const productModal = document.getElementById('product-modal');
            const cartModal = document.getElementById('cart-modal');
            const deliveryModal = document.getElementById('delivery-modal');
            const checkoutModal = document.getElementById('checkout-success-modal');
            const cartToast = document.getElementById('cart-toast');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartCountSpan = document.getElementById('cart-count');
            const cartSubtotalSpan = document.getElementById('cart-subtotal');
            const cartTotalSpan = document.getElementById('cart-total');
            const discountCodeInput = document.getElementById('discountCodeInput');
            const applyDiscountBtn = document.getElementById('apply-discount-btn');
            const discountMessage = document.getElementById('discount-message');
            const discountDisplay = document.getElementById('discount-display');
            const discountAmountSpan = document.getElementById('discount-amount');
            const gstDisplay = document.getElementById('gst-display');
            const cartGstPercentageSpan = document.getElementById('cart-gst-percentage');
            const cartGstAmountSpan = document.getElementById('cart-gst-amount');
            const confirmOrderBtn = document.getElementById('confirm-order-btn');
            const confirmOrderText = document.getElementById('confirm-order-text');
            const confirmOrderSpinner = document.getElementById('confirm-order-spinner');
            const codOptionLabel = document.getElementById('cod-option-label');
            const codAdvanceMessage = document.getElementById('cod-advance-message');

            // --- Helper Functions (Defined early to avoid ReferenceError) ---
            const openModal = (modalEl) => {
                modalEl.classList.remove('hidden');
                setTimeout(() => modalEl.querySelector('.modal-enter').classList.add('modal-enter-active'), 10);
            };

            const closeModal = (modalEl) => {
                const content = modalEl.querySelector('.modal-enter');
                content.classList.remove('modal-enter-active');
                content.classList.add('modal-leave-active');
                setTimeout(() => {
                    modalEl.classList.add('hidden');
                    content.classList.remove('modal-leave-active');
                }, 200);
            };

            const calculateAverageRating = (reviews) => {
                if (!reviews || reviews.length === 0) return 0;
                const total = reviews.reduce((sum, review) => sum + review.rating, 0);
                return total / reviews.length;
            };
            
            const createProductCard = (product) => {
                const card = document.createElement('div');
                card.className = 'group relative bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1';
                card.dataset.productId = product.id;
                
                const avgRating = calculateAverageRating(product.reviews);

                card.innerHTML = `
                    <div class="aspect-square overflow-hidden">
                        <img src="${product.images[0]}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                    </div>
                    <div class="p-3">
                        <h3 class="font-bold text-sm text-gray-800 truncate">${product.name}</h3>
                        <div class="flex items-center mt-1">
                            <div class="star-rating flex">
                                ${Array(5).fill(0).map((_, i) => `<svg class="w-4 h-4 ${i < Math.round(avgRating) ? 'filled' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`).join('')}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">(${product.reviews ? product.reviews.length : 0})</span>
                        </div>
                        <p class="font-extrabold text-lg text-gray-900 mt-1">₹${product.price.toLocaleString('en-IN')}</p>
                    </div>
                `;
                return card;
            };

            const updateCart = () => {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>';
                } else {
                    cart.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex items-center space-x-4 mb-4';
                        itemEl.innerHTML = `
                            <img src="${item.images[0]}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                            <div class="flex-grow">
                                <h4 class="font-bold text-sm">${item.name}</h4>
                                <p class="text-gray-600">₹${item.price.toLocaleString('en-IN')}</p>
                            </div>
                            <button data-id="${item.id}" class="remove-from-cart-btn text-red-500 hover:text-red-700"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                        `;
                        cartItemsContainer.appendChild(itemEl);
                    });
                }

                // Update totals
                let subtotal = cart.reduce((sum, item) => sum + item.price, 0);
                let total = subtotal;
                let discountValue = 0;

                // Apply discount
                if (appliedDiscount) {
                    if (appliedDiscount.type === 'percentage') {
                        discountValue = subtotal * (appliedDiscount.value / 100);
                    } else {
                        discountValue = appliedDiscount.value;
                    }
                    total -= discountValue;
                    discountDisplay.classList.remove('hidden');
                    discountAmountSpan.textContent = `- ₹${discountValue.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                } else {
                    discountDisplay.classList.add('hidden');
                }

                // Apply GST
                const gstPercentage = siteSettings.gstPercentage || 0;
                if (gstPercentage > 0) {
                    const gstAmount = total * (gstPercentage / 100);
                    total += gstAmount;
                    gstDisplay.classList.remove('hidden');
                    cartGstPercentageSpan.textContent = gstPercentage;
                    cartGstAmountSpan.textContent = `₹${gstAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                } else {
                    gstDisplay.classList.add('hidden');
                }

                cartSubtotalSpan.textContent = `₹${subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                cartTotalSpan.textContent = `₹${total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                
                // Update cart count bubble
                if (cart.length > 0) {
                    cartCountSpan.textContent = cart.length;
                    cartCountSpan.classList.remove('hidden');
                } else {
                    cartCountSpan.classList.add('hidden');
                }
                feather.replace();
            };

            const showToast = (message) => {
                cartToast.querySelector('span').textContent = message;
                cartToast.classList.remove('opacity-0');
                cartToast.classList.add('toast-animation');
                setTimeout(() => {
                    cartToast.classList.remove('toast-animation');
                    cartToast.classList.add('opacity-0');
                }, 3000);
            };
            
            const renderStars = (rating, containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const starSvg = `<svg class="w-5 h-5 ${i <= rating ? 'filled' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
                    container.innerHTML += starSvg;
                }
            };

            const displayProductDetails = (product) => {
                document.getElementById('modal-product-name').textContent = product.name;
                document.getElementById('modal-product-category').textContent = product.category;
                document.getElementById('modal-product-price').textContent = `₹${product.price.toLocaleString('en-IN')}`;
                document.getElementById('modal-main-image').src = product.images[0];
                
                const thumbnailsContainer = document.getElementById('modal-thumbnails');
                thumbnailsContainer.innerHTML = '';
                product.images.forEach((img, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = img;
                    thumb.className = `thumbnail w-full h-auto object-cover rounded-md cursor-pointer border-2 ${index === 0 ? 'active' : 'border-transparent'}`;
                    thumb.addEventListener('click', () => {
                        document.getElementById('modal-main-image').src = img;
                        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                    });
                    thumbnailsContainer.appendChild(thumb);
                });
                
                productModal.querySelector('.add-to-cart-btn').dataset.productId = product.id;
                document.getElementById('tab-content-description').textContent = product.details.description;
                document.getElementById('tab-content-specs').innerHTML = product.details.specifications;
                
                // Reviews
                const reviewsList = document.getElementById('reviews-list');
                const avgRating = calculateAverageRating(product.reviews);
                renderStars(avgRating, 'modal-avg-rating');
                document.getElementById('modal-review-count').textContent = `(${product.reviews ? product.reviews.length : 0} reviews)`;
                reviewsList.innerHTML = '';
                if (product.reviews && product.reviews.length > 0) {
                    product.reviews.forEach(review => {
                        reviewsList.innerHTML += `
                            <div class="border-b py-4">
                                <div class="flex items-center mb-1">
                                    <div class="star-rating flex">${Array(5).fill(0).map((_, i) => `<svg class="w-4 h-4 ${i < review.rating ? 'filled' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`).join('')}</div>
                                    <p class="ml-2 font-bold text-gray-800">${review.user}</p>
                                </div>
                                <p class="text-gray-600">${review.comment}</p>
                            </div>
                        `;
                    });
                } else {
                    reviewsList.innerHTML = '<p class="text-gray-500">No reviews yet.</p>';
                }
                feather.replace();
            };
            
            const attachProductClickHandlers = () => {
                mainContent.addEventListener('click', (e) => {
                    const card = e.target.closest('[data-product-id]');
                    if (card) {
                        const productId = card.dataset.productId;
                        const product = products.find(p => p.id === productId);
                        if (product) {
                            currentProductId = productId;
                            displayProductDetails(product);
                            openModal(productModal);
                        }
                    }
                });
            };

            // --- Dynamic Content Rendering (Firebase Listeners) ---
            onSnapshot(siteContentRef, (docSnap) => {
                if (docSnap.exists()) {
                    siteSettings = docSnap.data(); // Store all settings globally
                    document.getElementById('hero-title').textContent = siteSettings.heroTitle || 'Unleash Imagination';
                    document.getElementById('hero-subtitle').textContent = siteSettings.heroSubtitle || 'Discover a world of wonder...';
                    document.getElementById('footer-email').textContent = `Email: ${siteSettings.contactEmail || 'support@toytopia.com'}`;
                    document.getElementById('footer-phone').textContent = `Phone: ${siteSettings.contactPhone || '+91 12345 67890'}`;
                    document.getElementById('facebook-link').href = siteSettings.facebookUrl || '#';
                    document.getElementById('instagram-link').href = siteSettings.instagramUrl || '#';
                    document.getElementById('twitter-link').href = siteSettings.twitterUrl || '#';
                    updateCart(); // Recalculate cart totals when settings change
                }
            });

            onSnapshot(productsCollection, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(products);
                if (productModal.classList.contains('flex') && currentProductId) {
                    const updatedProduct = products.find(p => p.id === currentProductId);
                    if (updatedProduct) displayProductDetails(updatedProduct);
                    else closeModal(productModal);
                }
            });
            
            onSnapshot(categoriesCollection, (snapshot) => {
                renderCategories(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });

            const renderProducts = (productsToRender) => {
                productGrid.innerHTML = '';
                productsToRender.slice(0, 10).forEach(p => productGrid.appendChild(createProductCard(p)));
                feather.replace();
            };

            const renderCategories = (categories) => {
                categoryGrid.innerHTML = '';
                const colors = ['sky', 'pink', 'amber', 'teal', 'indigo', 'rose'];
                categories.forEach((cat, i) => {
                    const color = colors[i % colors.length];
                    const catEl = document.createElement('a');
                    catEl.href = '#shop';
                    catEl.className = 'group flex flex-col items-center p-4 rounded-xl hover:shadow-lg transition-all duration-300 bg-white';
                    catEl.innerHTML = `
                        <div class="bg-${color}-100 rounded-full p-4 flex justify-center items-center w-24 h-24 group-hover:bg-${color}-200 transition-colors duration-300">
                            <i data-feather="gift" class="w-12 h-12 text-${color}-500"></i>
                        </div>
                        <h3 class="mt-3 font-bold text-md text-gray-700 text-center">${cat.name}</h3>
                    `;
                    categoryGrid.appendChild(catEl);
                });
                feather.replace();
            };
            
            // --- Event Listeners ---
            attachProductClickHandlers();
            document.getElementById('cart-button').addEventListener('click', () => openModal(cartModal));
            document.getElementById('close-cart-modal-btn').addEventListener('click', () => closeModal(cartModal));
            document.getElementById('close-product-modal-btn').addEventListener('click', () => closeModal(productModal));
            
            productModal.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                const productId = e.currentTarget.dataset.productId;
                const product = products.find(p => p.id === productId);
                if (product) {
                    cart.push(product);
                    updateCart();
                    showToast('Item added to cart!');
                }
            });
            
            cartItemsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-from-cart-btn');
                if (removeBtn) {
                    const productId = removeBtn.dataset.id;
                    cart = cart.filter(item => item.id !== productId);
                    updateCart();
                }
            });

            // --- Delivery and Checkout Modals ---
            document.getElementById('delivery-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                // ... (validation logic remains the same) ...
                const fullNameInput = document.getElementById('fullName');
                const addressInput = document.getElementById('address');
                const cityInput = document.getElementById('city');
                const pincodeInput = document.getElementById('pincode');
                const phoneInput = document.getElementById('phone');

                // Simple client-side validation
                let isValid = true;
                [fullNameInput, addressInput, cityInput, pincodeInput, phoneInput].forEach(input => {
                    if (!input.value.trim() || !input.checkValidity()) {
                        input.classList.add('invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('invalid');
                    }
                });

                if (!isValid) {
                    showToast('Please fill in all details correctly.', 'error');
                    return;
                }

                const customerDetails = {
                    fullName: fullNameInput.value.trim(),
                    address: addressInput.value.trim(),
                    city: cityInput.value.trim(),
                    pincode: pincodeInput.value.trim(),
                    phone: phoneInput.value.trim(),
                };
                
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                
                // Show loading spinner
                confirmOrderText.classList.add('hidden');
                confirmOrderSpinner.classList.remove('hidden');
                confirmOrderBtn.disabled = true;

                if (selectedPaymentMethod === 'cod') {
                    // Handle COD order
                    await placeOrder(customerDetails, 'COD');
                } else {
                    // Handle Razorpay order
                    const orderTotal = parseFloat(cartTotalSpan.textContent.replace('₹', '').replace(/,/g, ''));
                    if (!siteSettings.razorpayKeyId) {
                        showToast('Online payment is not configured.', 'error');
                        // Hide spinner, enable button
                        confirmOrderText.classList.remove('hidden');
                        confirmOrderSpinner.classList.add('hidden');
                        confirmOrderBtn.disabled = false;
                        return;
                    }
                    try {
                        await initiateRazorpayPayment(customerDetails, orderTotal);
                    } catch (error) {
                        console.error("Payment failed or cancelled:", error);
                        showToast('Payment failed or was cancelled. Please try again.', 'error');
                        // Hide spinner, enable button
                        confirmOrderText.classList.remove('hidden');
                        confirmOrderSpinner.classList.add('hidden');
                        confirmOrderBtn.disabled = false;
                    }
                }
            });

            // --- Payment Logic (Razorpay and COD) ---
            async function placeOrder(customerDetails, paymentMethod, transactionId = null) {
                const orderCartItems = cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: 1
                }));

                const orderData = {
                    customerName: customerDetails.fullName,
                    orderDate: new Date().toISOString(),
                    products: orderCartItems,
                    subtotal: parseFloat(cartSubtotalSpan.textContent.replace('₹', '').replace(/,/g, '')),
                    discountApplied: appliedDiscount ? { code: appliedDiscount.code, type: appliedDiscount.type, value: appliedDiscount.value } : null,
                    gstPercentage: siteSettings.gstPercentage || 0,
                    gstAmount: parseFloat(cartGstAmountSpan.textContent.replace('₹', '').replace(/,/g, '')),
                    totalAmount: parseFloat(cartTotalSpan.textContent.replace('₹', '').replace(/,/g, '')),
                    paymentInfo: {
                        method: paymentMethod,
                        transactionId: transactionId,
                        status: paymentMethod === 'COD' ? 'pending' : 'completed'
                    },
                    shippingAddress: {
                        street: customerDetails.address,
                        city: customerDetails.city,
                        pincode: customerDetails.pincode,
                        phone: customerDetails.phone
                    },
                    status: paymentMethod === 'COD' ? 'Pending' : 'Processing'
                };

                try {
                    await addDoc(ordersCollection, orderData);
                    const customerQuery = await getDocs(collection(db, 'customers'));
                    const existingCustomer = customerQuery.docs.find(doc => doc.data().phone === customerDetails.phone);
                    if (!existingCustomer) {
                        await addDoc(customersCollection, customerDetails);
                    }

                    cart = [];
                    appliedDiscount = null;
                    discountCodeInput.value = '';
                    discountMessage.textContent = '';
                    updateCart();
                    closeModal(deliveryModal);
                    openModal(checkoutModal);
                    document.getElementById('delivery-form').reset();
                    feather.replace();
                    showToast('Your order has been placed successfully!', 'success');
                } catch (error) {
                    console.error("Error saving order:", error);
                    showToast("There was an issue placing your order. Please contact support.", 'error');
                } finally {
                    confirmOrderText.classList.remove('hidden');
                    confirmOrderSpinner.classList.add('hidden');
                    confirmOrderBtn.disabled = false;
                }
            }

            async function initiateRazorpayPayment(customerDetails, amount) {
                return new Promise((resolve, reject) => {
                    const options = {
                        key: siteSettings.razorpayKeyId,
                        amount: amount * 100,
                        currency: "INR",
                        name: "ToyTopia",
                        description: "Purchase from ToyTopia",
                        handler: async (response) => {
                            await placeOrder(customerDetails, 'Razorpay', response.razorpay_payment_id);
                            resolve(true);
                        },
                        prefill: {
                            name: customerDetails.fullName,
                            contact: customerDetails.phone
                        },
                        theme: { color: "#0ea5e9" }
                    };
                    const rzp1 = new Razorpay(options);
                    rzp1.on('payment.failed', (response) => reject(response.error));
                    rzp1.open();
                });
            }

            // --- Checkout Modal Logic ---
            document.getElementById('checkout-btn').addEventListener('click', () => {
                if (cart.length === 0) {
                    showToast('Your cart is empty!', 'error');
                    return;
                }
                // Check for COD availability
                if (siteSettings.codEnabled) {
                    codOptionLabel.classList.remove('hidden');
                    const advanceAmount = siteSettings.codAdvanceAmount || 0;
                    if (advanceAmount > 0) {
                        codAdvanceMessage.textContent = `A non-refundable advance of ₹${advanceAmount} is required for COD orders.`;
                        codAdvanceMessage.classList.remove('hidden');
                    } else {
                        codAdvanceMessage.classList.add('hidden');
                    }
                } else {
                    codOptionLabel.classList.add('hidden');
                }
                closeModal(cartModal);
                openModal(deliveryModal);
            });
            
            // ... (rest of the modal close buttons and initial setup) ...
            document.getElementById('close-delivery-modal-btn').addEventListener('click', () => closeModal(deliveryModal));
            document.getElementById('close-checkout-modal-btn').addEventListener('click', () => closeModal(checkoutModal));
            
            // Mobile menu and search bar toggles
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });
            document.getElementById('search-btn').addEventListener('click', () => {
                document.getElementById('search-bar').classList.toggle('hidden');
            });
            
            updateCart();
            feather.replace();
        }

        main().catch(console.error);
    </script>
</body>
</html>
